<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Katnallu ‚Äì Create Celebration</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial; background:#ffe9d6; }
.card { width:420px; margin:40px auto; background:#fff; padding:20px; border-radius:16px; }
input, button { width:100%; padding:10px; margin:8px 0; }
.gift-row { display:flex; gap:8px; }
.gift-row input { width:50%; }
button { background:#28a745; color:#fff; border:none; border-radius:8px; cursor:pointer; }
.add-btn { background:#ff9800; }
.link-box { background:#f1f1f1; padding:10px; word-break:break-all; }
</style>
</head>

<body>
<div class="card">
<h2>üéâ Create Celebration</h2>

<input id="occasion" placeholder="Occasion name">
<input id="date" type="date">
<input id="upi" placeholder="UPI ID">
<input id="photo" type="file">

<h3>üéÅ Gifts</h3>
<div id="gifts"></div>

<button class="add-btn" onclick="addGift()">+ Add Gift</button>
<button onclick="saveCelebration()">Save & Generate Link üîó</button>

<div id="result"></div>
</div>

<script>
const supabase = supabase.createClient(
  "https://jdzerwfwrsctemjwxqru.supabase.co",
  "PASTE_YOUR_PUBLISHABLE_KEY_HERE"
);

function addGift(){
  const row = document.createElement("div");
  row.className = "gift-row";
  row.innerHTML = `
    <input placeholder="Gift name">
    <input type="number" placeholder="Amount">
  `;
  document.getElementById("gifts").appendChild(row);
}

addGift(); // first row

async function saveCelebration(){
  const occasion = document.getElementById("occasion").value;
  const date = document.getElementById("date").value;
  const upi = document.getElementById("upi").value;
  const photo = document.getElementById("photo").files[0];

  const fileName = Date.now()+"_"+photo.name;
  await supabase.storage.from("celebration-images").upload(fileName, photo);

  const image_url = supabase.storage
    .from("celebration-images")
    .getPublicUrl(fileName).data.publicUrl;

  const { data: celebration } = await supabase
    .from("celebrations")
    .insert({ occasion, event_date: date, upi, image_url })
    .select()
    .single();

  const giftRows = document.querySelectorAll(".gift-row");
  for (let row of giftRows){
    const name = row.children[0].value;
    const amount = row.children[1].value;
    if(name && amount){
      await supabase.from("gifts").insert({
        celebration_id: celebration.id,
        name,
        amount
      });
    }
  }

  const link = `${location.origin}${location.pathname.replace("index.html","")}contribute.html?id=${celebration.id}`;
  document.getElementById("result").innerHTML = `
    <p>üéâ Share this link:</p>
    <div class="link-box">${link}</div>
  `;
}
</script>
</body>
</html>
